apiVersion: v1
kind: Service
metadata:
  name: codeintel-python-service
spec:
  selector:
    app: sourcegraph
  ports:
    - port: 2087
      targetPort: 2087
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: codeinel-python-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sourcegraph
  template:
    metadata:
      labels:
        app: sourcegraph
    spec:
      containers:
        - name: codeintel-python
          image: sourcegraph/codeintel-python:18892_2018-07-27_ddc9943
          resources:
            limits:
              memory: 512Mi
              cpu: 1
          ports:
            - containerPort: 2087
---
apiVersion: v1
kind: Service
metadata:
  name: sourcegraph-service
spec:
  selector:
    app: sourcegraph
  ports:
    - port: 80
      targetPort: 7080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sourcegraph-deployment
  labels:
    app: sourcegraph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sourcegraph
  template:
    metadata:
      labels:
        app: sourcegraph
    spec:
      containers:
        - name: sourcegraph
          image: "sourcegraph/server:3.0.1"
          resources:
            limits:
              memory: 2Gi
              cpu: 1
          ports:
            - containerPort: 7080
          volumeMounts:
            - name: sourcegraph-secrets
              mountPath: /etc/sourcegraph
            - name: sourcegraph-data
              mountPath: /var/opt/sourcegraph
          envFrom:
            - secretRef:
                name: sourcegraph-secret
          livenessProbe:
            httpGet:
              path: /
              port: 7080
            initialDelaySeconds: 10
            timeoutSeconds: 3
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /
              port: 7080
            initialDelaySeconds: 5
            timeoutSeconds: 3
            periodSeconds: 5
      volumes:
        - name: sourcegraph-secrets
          hostPath:
            path: /opt/share/kubernetes/secrets/sourcegraph
            type: Directory
        - name: sourcegraph-data
          hostPath:
            path: /opt/share/kubernetes/sourcegraph
            type: Directory
---
apiVersion: v1
kind: Secret
metadata:
  name: sourcegraph-secret
type: Opaque
stringData:
  PGPORT: "5432"
  PGHOST: "postgres.ocf.berkeley.edu"
  PGUSER: "ocfsourcegraph"
  PGPASSWORD: "<%= sourcegraph_pgpassword %>"
  PGDATABASE: "ocfsourcegraph"
  PGSSLMODE: "require"
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: sourcegraph-ingress
spec:
  rules:
    - host: sourcegraph.ocf.berkeley.edu
      http:
        paths:
          - backend:
              serviceName: sourcegraph-service
              servicePort: 80
